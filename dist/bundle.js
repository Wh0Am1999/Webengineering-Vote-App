(()=>{"use strict";var e={55:(e,t,n)=>{n.d(t,{Gi:()=>r,Ps:()=>l,deletePoll:()=>i,gU:()=>a});const o="/api/polls";async function l(){const e=await fetch(o);if(!e.ok)throw new Error("Fehler beim Laden der Polls");return e.json()}async function a(e){const t=await fetch(`${o}/${e}`);if(!t.ok)throw new Error("Poll nicht gefunden");return t.json()}async function r(e){const t=localStorage.getItem("token"),n=await fetch("/api/polls",{method:"POST",headers:{"Content-Type":"application/json",authorization:t||""},body:JSON.stringify(e)});if(!n.ok)throw new Error("Erstellen fehlgeschlagen");return n.json()}async function i(e){const t=localStorage.getItem("token"),n=await fetch(`/api/polls/${e}`,{method:"DELETE",headers:{authorization:t||""}});if(!n.ok)throw new Error("Löschen fehlgeschlagen");return n.json()}}},t={};function n(o){var l=t[o];if(void 0!==l)return l.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var o=n(55);const l={polls:[],currentPoll:null};async function a(){const e=await fetch("./html/components/nav/nav.html").then((e=>e.text()));document.getElementById("nav-root").innerHTML=e;const t=localStorage.getItem("avatarUrl"),n=document.querySelector(".nav-avatar-container");n&&(n.innerHTML="",t&&(n.innerHTML=`<img src="${t}" alt="Profilbild" class="nav-avatar" />`));const o=document.getElementById("nav-links");o.innerHTML="",o.innerHTML='\n    <li><a href="#/" class="nav-home">Home</a></li>\n  ',localStorage.getItem("token")?(o.innerHTML+=`\n      <li><a href="#/new" class="nav-newpoll">Neue Abstimmung</a></li>\n      <li>\n        <a href="#" id="logout-link" class="logout-link">\n          <span class="logout-text">Logout (${localStorage.getItem("username")})</span>\n          <span class="logout-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></span>\n        </a>\n      </li>\n    `,setTimeout((()=>{document.getElementById("logout-link").onclick=e=>{e.preventDefault(),localStorage.removeItem("token"),localStorage.removeItem("username"),localStorage.removeItem("avatarUrl"),window.location.hash="#/login",a()}}),0)):o.innerHTML+='\n      <li><a href="#/login">Login</a></li>\n      <li><a href="#/register">Registrieren</a></li>\n    '}async function r(){const e=window.location.hash;if(!localStorage.getItem("token")||"#/"!==e&&"#/polls"!==e&&""!==e&&"#/home"!==e)document.getElementById("action-btn-root").innerHTML="";else{const e=await fetch("./html/components/action-button/action-button.html").then((e=>e.text()));document.getElementById("action-btn-root").innerHTML=e,document.getElementById("action-btn").onclick=()=>{window.location.hash="#/new"}}}function i(){const e=window.location.hash||"#/",[t,i,c,s]=e.split("/"),d=!!localStorage.getItem("token");""===i||"home"===i?d?async function(){document.getElementById("app-root").innerHTML='\n    <div class="loading">\n      <div class="loading-spinner"></div>\n      <div>Lädt...</div>\n    </div>\n  ';let e=[];try{e=await(0,o.Ps)(),l.polls=e}catch(e){return void(document.getElementById("app-root").innerHTML='\n      <div class="error-box show">Fehler beim Laden der Abstimmungen.</div>\n    ')}const t=await fetch("./html/components/poll-list/poll-list.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=t;const n=document.getElementById("sort-select");function a(e,t){switch(t){case"date-asc":return e.slice().sort(((e,t)=>new Date(e.createdAt)-new Date(t.createdAt)));case"title-asc":return e.slice().sort(((e,t)=>e.title.localeCompare(t.title)));case"title-desc":return e.slice().sort(((e,t)=>t.title.localeCompare(e.title)));default:return e.slice().sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)))}}function i(e){const t=document.getElementById("poll-list-cards");t.innerHTML="";for(const n of e)fetch("./html/components/poll-card/poll-card.html").then((e=>e.text())).then((e=>{const o=document.createElement("div");o.innerHTML=e.trim();const l=o.firstElementChild;l.querySelector(".poll-title").textContent=n.title,l.querySelector(".poll-date").textContent=new Date(n.createdAt).toLocaleDateString("de-CH",{day:"2-digit",month:"2-digit",year:"numeric"})+",",l.querySelector(".poll-creator").textContent=n.creator||"Unbekannt",l.querySelector(".poll-description").textContent=n.description||"",l.querySelector(".poll-detail-btn").onclick=()=>{window.location.hash=`#/poll/${n.id}`},t.appendChild(l)}))}i(a(e,"date-desc")),n.addEventListener("change",(()=>{i(a(e,n.value))})),r()}():fetch("./html/components/home/home.html").then((e=>e.text())).then((e=>{document.getElementById("app-root").innerHTML=e})):"login"===i?async function(){const e=await fetch("./html/components/login/login.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=e,document.querySelector("input")?.focus(),document.getElementById("login-form").onsubmit=async e=>{e.preventDefault();const t=e.target,n=t.querySelector("button[type='submit']"),o=t.email.value.trim(),l=t.password.value;if(function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(o)){n.disabled=!0,n.innerHTML='<span class="loading-spinner" style="width:1em; height:1em; border-width:0.18em; vertical-align:middle"></span> Wird gesendet...';try{const e=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,password:l})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Fehler");localStorage.setItem("token",t.token),localStorage.setItem("username",t.username),localStorage.setItem("avatarUrl",t.avatarUrl||""),window.location.hash="#/polls",await a()}catch(e){document.getElementById("login-error").textContent=e.message}finally{n.disabled=!1,n.textContent="Login"}}else document.getElementById("login-error").textContent="Bitte eine gültige E-Mail-Adresse eingeben!"}}():"register"===i?async function(){const e=await fetch("./html/components/register/register.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=e,document.querySelector("input")?.focus(),document.getElementById("register-form").onsubmit=async e=>{e.preventDefault();const t=e.target,n=t.querySelector("button[type='submit']"),o=t.username.value.trim(),l=t.email.value.trim(),a=t.password.value,r=t.avatarUrl.value.trim();if(function(e){return"string"==typeof e&&e.length>=3&&e.length<=12&&!/\s/.test(e)}(o))if(function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(l))if(function(e){return e.length>=12&&/[A-Z]/.test(e)&&/[a-z]/.test(e)&&/\d/.test(e)}(a))if(function(e){if(!e)return!0;try{return new URL(e),!0}catch{return!1}}(r)){n.disabled=!0,n.innerHTML='<span class="loading-spinner" style="width:1em; height:1em; border-width:0.18em; vertical-align:middle"></span> Wird gesendet...';try{const e=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o,email:l,password:a,avatarUrl:r})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Fehler");alert("Registrierung erfolgreich! Bitte einloggen."),window.location.hash="#/login"}catch(e){document.getElementById("register-error").textContent=e.message}finally{n.disabled=!1,n.textContent="Registrieren"}}else document.getElementById("register-error").textContent="Bitte eine gültige Bild-URL angeben (optional).";else document.getElementById("register-error").textContent="Passwort muss mind. 12 Zeichen lang sein, einen Grossbuchstaben, einen Kleinbuchstaben und eine Zahl enthalten!";else document.getElementById("register-error").textContent="Bitte eine gültige E-Mail-Adresse eingeben!";else document.getElementById("register-error").textContent="Benutzername muss zwischen 3 und 12 Zeichen lang sein und darf keine Leerzeichen enthalten!"}}():"poll"===i&&c&&"results"===s?async function(e){const t=document.getElementById("vote-form");let n;t&&t.remove(),document.getElementById("app-root").innerHTML='\n    <div class="loading">\n      <div class="loading-spinner"></div>\n      <div>Lädt...</div>\n    </div>\n  ';try{n=await(0,o.gU)(e)}catch(e){return void(document.getElementById("app-root").innerHTML='<div class="error-box show">Fehler beim Laden der Ergebnisse.</div>')}const l=await fetch("./html/components/poll-result/poll-result.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=l;const a=document.getElementById("poll-result-chart");a.innerHTML="";const r=n.options.reduce(((e,t)=>e+(t.votes||0)),0);n.options.forEach((e=>{const t=r?((e.votes||0)/r*100).toFixed(1):0,n=document.createElement("div");n.className="poll-bar-row";const o=document.createElement("span");o.className="poll-bar-label",o.textContent=function(e,t=32){return e?e.length>t?e.slice(0,t-1)+"…":e:""}(e.text,15),o.title=e.text;const l=document.createElement("div");l.className="poll-bar-outer";const i=document.createElement("div");i.className="poll-bar-inner",i.style.width=t>0?t+"%":"0",l.appendChild(i);const c=document.createElement("span");c.className="poll-bar-value",c.textContent=`${e.votes||0} (${t}%)`,n.appendChild(o),n.appendChild(l),n.appendChild(c),a.appendChild(n)}));const i=document.querySelector(".back-btn");i&&(i.onclick=e=>{e.preventDefault(),window.location.hash=`#/poll/${n.id}`})}(c):"poll"===i&&c?async function(e){let t;document.getElementById("app-root").innerHTML='\n    <div class="loading">\n      <div class="loading-spinner"></div>\n      <div>Lädt...</div>\n    </div>\n  ';try{t=await(0,o.gU)(e)}catch(e){return void(document.getElementById("app-root").innerHTML='<div class="error-box show">Abstimmung nicht gefunden.</div>')}const l=await fetch("./html/components/poll-detail/poll-detail.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=l,document.querySelector(".poll-title").textContent=t.title,document.querySelector(".poll-creator").textContent=t.creator||"Unbekannt",document.querySelector(".poll-date").textContent=function(e){const t=new Date(e);return isNaN(t.getTime())?"":`${String(t.getDate()).padStart(2,"0")}.${String(t.getMonth()+1).padStart(2,"0")}.${t.getFullYear()}`}(t.createdAt);const a=document.getElementById("poll-options");a.innerHTML="",t.options.forEach((e=>{const n=document.createElement("label"),o=document.createElement("input");o.type=t.multiple?"checkbox":"radio",o.name="option",o.value=e.id,n.appendChild(o),n.append(" "+e.text),a.appendChild(n)}));const r=document.getElementById("vote-form");r.onsubmit=async e=>{if(e.preventDefault(),!localStorage.getItem("token"))return void(window.location.hash="#/login");const n=[...r.querySelectorAll("input")].filter((e=>e.checked)).map((e=>e.value));if(0!==n.length)try{await fetch(`/api/polls/${t.id}/vote`,{method:"POST",headers:{"Content-Type":"application/json",authorization:localStorage.getItem("token")},body:JSON.stringify({optionIds:n})}),setTimeout((()=>window.location.hash=`#/poll/${t.id}/results`),800)}catch(e){alert("Abstimmen fehlgeschlagen.")}else alert("Bitte wähle mindestens eine Option.")},document.querySelector(".view-result-btn").onclick=()=>{window.location.hash=`#/poll/${t.id}/results`};let i=null;function c(){const e=document.querySelector(".vote-btn"),t=document.querySelector(".view-result-btn");e&&t&&(window.innerWidth<900?(e.innerHTML='<i class="fa-solid fa-paper-plane"></i>',t.innerHTML='<i class="fa-solid fa-chart-bar"></i>',i&&(i.innerHTML='<i class="fa-solid fa-trash"></i>')):(e.innerHTML='<i class="fa-solid fa-paper-plane"></i> Abstimmen',t.innerHTML='<i class="fa-solid fa-chart-bar"></i> Resultat anzeigen',i&&(i.innerHTML='<i class="fa-solid fa-trash"></i> Abstimmung löschen')))}t.creator&&localStorage.getItem("username")&&t.creator.toLowerCase()===localStorage.getItem("username").toLowerCase()&&(i=document.createElement("button"),i.className="danger-btn btn btn-danger d-flex align-items-center justify-content-center",document.querySelector(".poll-detail").appendChild(i),i.onclick=async()=>{if(confirm("Wirklich löschen?"))try{const{deletePoll:e}=await Promise.resolve().then(n.bind(n,55));await e(t.id),alert("Abstimmung gelöscht!"),window.location.hash="#/polls"}catch(e){alert("Löschen fehlgeschlagen: "+e.message)}}),c(),window.addEventListener("resize",c)}(c):"new"===i?async function(){if(!localStorage.getItem("token"))return void(window.location.hash="#/login");const e=await fetch("./html/components/poll-form/poll-form.html").then((e=>e.text()));document.getElementById("app-root").innerHTML=e;let t=["",""];function n(){const e=document.getElementById("option-list");e.innerHTML="",t.forEach(((o,l)=>{const a=document.createElement("div");a.className="option-row";const r=document.createElement("input");if(r.type="text",r.value=o,r.placeholder=`Option ${l+1}`,r.required=!0,r.name="option",r.oninput=e=>{t[l]=e.target.value},a.appendChild(r),t.length>2){const e=document.createElement("button");e.type="button",e.className="remove-option-btn",e.innerHTML='<i class="fa-solid fa-minus"></i>',e.onclick=()=>{t.splice(l,1),n()},a.appendChild(e)}e.appendChild(a)}))}n(),document.getElementById("add-option-btn").onclick=()=>{t.push(""),n()},document.getElementById("new-poll-form").onsubmit=async e=>{e.preventDefault();const n=e.target.title.value.trim(),l=e.target.description.value.trim(),a=e.target.multiple.checked,r=t.map(((e,t)=>e.trim())).filter(Boolean);if(!n||r.length<2)document.getElementById("pollform-error").textContent="Bitte Titel und mindestens 2 Optionen angeben.";else{document.getElementById("pollform-error").textContent="";try{await(0,o.Gi)({title:n,description:l,options:r.map((e=>({text:e}))),multiple:a}),window.location.hash="#/polls"}catch(e){document.getElementById("pollform-error").textContent="Erstellen fehlgeschlagen."}}}}():window.location.hash="#/",r()}document.addEventListener("DOMContentLoaded",(async()=>{const e=function(){const e=localStorage.getItem("token");return!(!e||function(e){if(!e)return!0;try{const t=e.split(".")[1],n=atob(t.replace(/-/g,"+").replace(/_/g,"/")),o=JSON.parse(n);return Date.now()/1e3>o.exp}catch(e){return!0}}(e))||(localStorage.removeItem("token"),localStorage.removeItem("username"),!1)}();await a(),await async function(){const e=await fetch("./html/components/footer/footer.html").then((e=>e.text()));document.getElementById("footer-root").innerHTML=e}(),r(),window.location.hash&&"#"!==window.location.hash||(window.location.hash=e?"#/":"#/login"),window.addEventListener("hashchange",i),i()}))})();